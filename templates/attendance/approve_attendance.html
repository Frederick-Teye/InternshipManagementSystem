{% extends "dashboards/base.html" %}

{% block title %}Review Attendance - {{ block.super }}{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title mb-0">
          <i class="fas fa-clipboard-check"></i> Review Attendance Request
        </h4>
      </div>
      <div class="card-body">
        <!-- Intern Info -->
        <div class="mb-4">
          <h5>Intern Information</h5>
          <div class="row">
            <div class="col-md-6">
              <strong>Name:</strong> {{ attendance.intern.user.get_full_name }}
            </div>
            <div class="col-md-6">
              <strong>Email:</strong> {{ attendance.intern.user.email }}
            </div>
            <div class="col-md-6 mt-2">
              <strong>Intern Type:</strong> {{ attendance.intern.intern_type.display_name|default:"N/A" }}
            </div>
            <div class="col-md-6 mt-2">
              <strong>School:</strong> {{ attendance.intern.school|default:"Not specified" }}
            </div>
          </div>
        </div>

        <hr>

        <!-- Attendance Details -->
        <div class="mb-4">
          <h5>Attendance Details</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong>Branch:</strong> {{ attendance.branch.name }}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Date:</strong> {{ attendance.check_in_time|date:"l, F j, Y" }}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Check-in Time:</strong> {{ attendance.check_in_time|time:"H:i:s" }}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Status:</strong> 
              <span class="badge bg-warning">Pending Approval</span>
            </div>
          </div>
        </div>

        <hr>

        <!-- Location Information -->
        <div class="mb-4">
          <h5>Location Verification</h5>
          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="alert {% if distance and distance <= attendance.branch.proximity_threshold_meters %}alert-success{% else %}alert-warning{% endif %}">
                {% if distance %}
                  <i class="fas {% if distance <= attendance.branch.proximity_threshold_meters %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
                  <strong>Distance from branch:</strong> {{ distance|floatformat:0 }} meters
                  {% if distance <= attendance.branch.proximity_threshold_meters %}
                    <br><small>Within acceptable range ({{ attendance.branch.proximity_threshold_meters }}m threshold)</small>
                  {% else %}
                    <br><small>Outside acceptable range ({{ attendance.branch.proximity_threshold_meters }}m threshold)</small>
                  {% endif %}
                {% else %}
                  <i class="fas fa-info-circle"></i>
                  <strong>Branch coordinates not configured.</strong> Manual verification required.
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <strong>Coordinates:</strong><br>
              <small class="text-muted">
                Lat: {{ attendance.latitude|floatformat:6 }}<br>
                Lon: {{ attendance.longitude|floatformat:6 }}
              </small>
            </div>
            <div class="col-md-6">
              <strong>Location Accuracy:</strong><br>
              <small class="text-muted">
                {% if attendance.location_accuracy_m %}
                  Â±{{ attendance.location_accuracy_m|floatformat:1 }} meters
                {% else %}
                  Not reported
                {% endif %}
              </small>
            </div>
          </div>
        </div>

        {% if attendance.notes %}
          <hr>
          <div class="mb-4">
            <h5>Intern Notes</h5>
            <div class="p-3 bg-light rounded">
              {{ attendance.notes|linebreaks }}
            </div>
          </div>
        {% endif %}

        <hr>

        <!-- Approval Form -->
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-3">
            <label class="form-label"><strong>Decision *</strong></label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="action" value="approve" id="action_approve" required>
              <label class="form-check-label text-success" for="action_approve">
                <i class="fas fa-check-circle"></i> <strong>Approve</strong> - Mark attendance as approved
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="action" value="reject" id="action_reject" required>
              <label class="form-check-label text-danger" for="action_reject">
                <i class="fas fa-times-circle"></i> <strong>Reject</strong> - Reject this attendance
              </label>
            </div>
          </div>

          <div class="mb-3">
            <label for="{{ form.note.id_for_label }}" class="form-label">
              Notes <small class="text-muted">(Required for rejection)</small>
            </label>
            {{ form.note }}
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-paper-plane"></i> Submit Decision
            </button>
            <a href="{% url 'attendance:pending_approvals' %}" class="btn btn-outline-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}